---
title: "Borealis-3Di-v03 - NM Workaround & pipeline"
output: pdf_document
date: "`r Sys.Date()`"
---

THIS VERSION IS BASED ON NM TRAJECTORIES AND SERVES TO HELP BUILDING THE 
PROCESSING PIPELINE.

```{r, message=FALSE}
library(tidyverse)
library(sf)

# set defaults
ggplot2::theme_set(ggplot2::theme_minimal())
```


# Overview

The 3Di algorithm is a composite index that combines observed horizontal and vertical (in)efficiencies as a weighted score.

The metric builds on a  surveillance trajectory for an airborne flight from which it extracts key movement events/milestones.
These milestones comprise

* START/STOP - first and last surveillance position
* LVL_START/LVL_END - for all level segments observed
* TOC/TOD - for the definition of flight phases (CLIMB, ENROUTE, DESCENT)
* additional key milestone events
  + airspace crossings - (for later aggregation on FIR / AOR basis)
  + tbd
  
```{r, out.width="60%"}
knitr::include_graphics("./figures/concept-3Di.png")
```


The algorithm entails

* horizontal component - expressed as the route extension $\tau$
* vertical component - a time- and level-weighted factor 

$$
v_{phase} =
\begin{cases}
\frac{t_i}{T} \frac{(RFL - l_i)}{RFL} = \frac{t_i}{T} * (1 - \frac{l_i}{RFL}) ,& l_i \leq RFL \\
0 ,& l_i > RFL
\end{cases}
$$

$t_i$ time at level
$l_i$ FL of i-th level segment

The vertical component requires also the RFL.
This will be extracted from the NM Flight Table (as only a max FL can be deducted from the trajectory).

The principal data processing can be summarised as follows:

```{r, out.width="60%"}
knitr::include_graphics("./figures/conceptual-pipeline-3Di.png")
```


# Data Preparatory Step

## Trajectory Data

For this initial run, the NM trajectory for a subset of inter-Borealis flights was extracted.

```{}
# DO NOT RUN - FOR DOKU PURPOSES - MIGHT REQUIRE LOCAL DATA NOT IN CLOUD
# Sam prepared trajectories for the first part of 2023
# these are read in, some data cleaning and stored as analytical data 
source("./R/read_and_fix_NM_trjs.R")
source("./R/standardise_trj_NM.R")

mof    <- "042023"
rmof   <- "202304"

fn     <- paste0("./data/3Di_", mof, ".csv")
fn_out <- paste0("./data/NM-TRJ-", rmof, "-Sam1.parquet")

trjs <- read_and_fix_NM_trjs(fn) |>
  standardise_traj_from_NM()

# check cleaning success
colSums(is.na(trjs))
  
arrow::write_parquet(trjs, sink = fn_out)
```

For this study, a `trajectory` describes the airborne portion of a flight.
A trajectory is a ordered time series of 4D positions, i.e. TIME, LAT, LON, ALT.
We express ALT as general flight levels FL in decimal form, i.e. FL = ALT / 100.

A `trajectory set` comprises multiple flights (e.g. flight between an aerodrome pair, specific day).

A standardised trajectory (and associated trjectory set) follows the `tidy data` paradigm.

The standardised trajectory comprises 

* UID - a unique id for this study to identify the flight
  + TODO: NM offers to use SAM_ID; should follow the standard pattern proposed
* 4D position - TIME, LAT, LON, FL
* optional
  + SEQ_ID
  + DIST_FLOWN
  
Note: from a data standaridation perspective the SEQ_ID and DIST_FLOWN can be 
calculated from the series of 4D positions.

Note2: for this iteration, the airspace crossing algorithm builds on the existence of a sequence numbering to allocate the crossing point as an additional trajectory point (with interpolated TIME and FL).    
TODO - to harden the code, replacing the SEQ_ID with TIME might be beneficial.

Note3: The NM trajectory source data has confused columns, i.e. decimal numbers with comma.
The cleaning "overlooks" - currently - positions that sit on on integer LON. 
On average we have 1-3 missing LONs per month. 
TIMEs for midnight appear non-standard and result in NA (about 1-2 in some files).
TODO - improve cleaning script.


## Airspace Data

The FIR boundaries were extracted from {pruatlas} and stored as an R data object, i.e. `borealis_firs`.

```{}
# DO NOT RUN - FOR DOKU PURPOSES - MIGHT REQUIRE LOCAL DATA NOT IN CLOUD
# prepare - read-in and save for future use without pruatlas
source("./R/get_firs.R")
borealis_firs <- get_borealis_firs() 
save(borealis_firs, file = "./data/FIR-borealis_firs.rda")
```

Read in the FIR airpace definitions.

```{r}
# make available borealis_firs
load("./data/FIR-borealis_firs.rda")
```

Have a quick glance

```{r}
ggplot() +
  geom_sf(data = borealis_firs)
```

