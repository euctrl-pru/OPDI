# Phase detection algorithm by Junzi Sun & the PySpark implementation

The fuzzy logic for identifying flight phases in trajectory data works by using fuzzy membership functions to determine the degree to which various flight parameters (altitude, speed, rate of climb) belong to different flight phases. Here's a detailed breakdown of how this fuzzy matching works in the provided code:

## 1. Initialization of Membership Functions
The __init__ method initializes the membership functions for altitude, rate of climb (RoC), speed, and states. These membership functions are used to evaluate how well each parameter fits into certain categories:

Altitude:

* alt_gnd: Ground level (using a Z-shaped membership function).
* alt_lo: Low altitude (using a Gaussian membership function).
* alt_hi: High altitude (using a Gaussian membership function).

Rate of Climb (RoC):

* roc_zero: Zero RoC (using a Gaussian membership function).
* roc_plus: Positive RoC (climb) (using an S-shaped membership function).
* roc_minus: Negative RoC (descent) (using a Z-shaped membership function).

Speed:

* spd_hi: High speed (using a Gaussian membership function).
* spd_md: Medium speed (using a Gaussian membership function).
* spd_lo: Low speed (using a Gaussian membership function).

States:

* state_ground: Ground phase.
* state_climb: Climb phase.
* state_descent: Descent phase.
* state_cruise: Cruise phase.
* state_level: Level flight phase.

## 2. Setting Trajectory Data
The set_trajectory method is used to set the time series data for the flight's altitude, speed, and rate of climb. It ensures that all input lists have the same length.

## 3. Fuzzy Logic for Determining Phase Labels
The phaselabel method uses fuzzy logic to determine the phase label for each time window:

* Time Window: The data is divided into time windows of a specified duration (default is 60 seconds).
* Membership Calculation: For each time window, the mean values of altitude, speed, and RoC are calculated. These mean values are then used to determine the membership levels for the altitude, speed, and RoC membership functions.
* Rule Evaluation: The rules for determining flight phases are evaluated using the minimum operator (AND logic). For example, the rule for the ground phase is determined by the minimum of alt_level_gnd, roc_level_zero, and spd_level_lo.
* State Activation: The state activation for each rule is calculated using the fuzzy minimum operator (np.fmin).
* Aggregation: The results from all rules are aggregated using the maximum operator (np.max).
* Defuzzification: The final state is determined using the "last of maximum" (lom) defuzzification method. This converts the fuzzy output into a crisp value representing the flight phase.

## 4. Flight Phase Indices
The flight_phase_indices method determines the indices of the data corresponding to different flight phases:

* Takeoff and Initial Climb (_get_to_ic): Identifies the indices for the takeoff and initial climb phases based on altitude and speed changes.

```{python}
F.when((col("prev_phase") == "GND") & (col("next_phase") == "CL"), F.array(F.lit("take-off")))
```

* Climb (_get_cl): Identifies the indices for the climb phase based on the labels generated by phaselabel.

```{python}
df_with_phases.withColumn("prev_phase", lag("flight_phase", 1, "None").over(window_spec))
```

* Descent (_get_de): Identifies the indices for the descent phase based on the labels generated by phaselabel.
```{python}
df_with_phases.withColumn("prev_phase", lag("flight_phase", 1, "None").over(window_spec))
```

* Cruise (_get_cr): Identifies the indices for the cruise phase by finding the period between climb and descent phases.
```{python}
df_with_phases.withColumn("first_cr_time", F.min(when(col("flight_phase") == "CR", col("event_time"))).over(window_spec_cumulative))
df_with_phases.withColumn("last_cr_time", F.max(when(col("flight_phase") == "CR", col("event_time"))).over(window_spec_cumulative))
```

* Final Approach and Landing (_get_fa_ld): Identifies the indices for the final approach and landing phases based on altitude and speed changes.
```{python}
F.when((col("prev_phase") == "DE") & (col("flight_phase") == "GND"), F.array(F.lit("landing")))
```
The method then compiles these indices into a dictionary and returns it.

## Summary

The fuzzy logic approach allows the identification of flight phases by evaluating the membership levels of altitude, speed, and rate of climb against predefined fuzzy sets. By using fuzzy rules and defuzzification, the method provides a robust way to classify different flight phases from continuous flight data.
